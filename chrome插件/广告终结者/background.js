function removeDeprecatedOptions(){var e=["videoAdkill","videoblockcontent","videokillsublink","videoupdatemeta"];e.forEach(function(e){e in localStorage&&delete localStorage[e]})}function setDefaultOptions(){function e(e,t){e in localStorage||(localStorage[e]=t)}e("shouldShowIcon","true"),e("shouldShowBlockElementMenu","true"),removeDeprecatedOptions()}function isWhitelisted(e,t,o){var n=e.indexOf("#");n>=0&&(e=e.substring(0,n));var r=defaultMatcher.matchesAny(e,o||"DOCUMENT",extractHostFromURL(t||e),!1);return r instanceof WhitelistFilter?r:null}function refreshIconAndContextMenu(e){if(e){var t=isWhitelisted(e.url),o=t?"icons/abp-19-whitelisted.png":"icons/abp-19.png";activeNotification?startIconAnimation(e,o):chrome.browserAction.setIcon({tabId:e.id,path:o}),/^https?:/.test(e.url)&&(chrome.browserAction.setTitle({tabId:e.id,title:"广告终结者"}),t?chrome.contextMenus.removeAll():showContextMenu())}}function doUpdateOrInstall(e,t){function o(){chrome.tabs.create({url:chrome.extension.getURL("firstRun.html")})}if(localStorage.notificationRules=!0,void 0==t)o();else{var n=t.split(".")[0];if("2"==n||"1"==n){console.log("update");var r="https://easylist-downloads.adblockplus.org/chinalist+easylist.txt";r in FilterStorage.knownSubscriptions&&FilterStorage.removeSubscription(FilterStorage.knownSubscriptions[r]),o()}else Cscript.add("去视频广告脚本","http://sub.adtchrome.com/videoadjs.txt"),Cscript.add("HTML5播放","http://sub.adtchrome.com/html5player.txt"),FilterStorage.removeSubscription(Subscription.fromURL(Prefs.subscriptions_videoblockurl)),subscription.disabled=!1,console.log("更新 "+t)}}function showContextMenu(){chrome.contextMenus.removeAll(function(){"string"==typeof localStorage.shouldShowBlockElementMenu&&"true"==localStorage.shouldShowBlockElementMenu&&chrome.contextMenus.create({title:chrome.i18n.getMessage("block_element"),contexts:["image","video","audio"],onclick:function(e,t){e.srcUrl&&chrome.tabs.sendMessage(t.id,{reqtype:"clickhide-new-filter",filter:e.srcUrl})}})})}function openOptions(e){function t(e){for(var t=chrome.extension.getViews({type:"tab"}),o=0;o<t.length;o++)if("startSubscriptionSelection"in t[o])return t[o];return null}function o(){chrome.windows.getAll({populate:!0},function(e){for(var t=chrome.extension.getURL("options.html"),o=0;o<e.length;o++)for(var n=0;n<e[o].tabs.length;n++)e[o].tabs[n].url==t&&chrome.tabs.update(e[o].tabs[n].id,{selected:!0})})}var n=t();if(n)o(),e(n);else{var r=function(){var o=t();o&&e(o)};chrome.tabs.create({url:chrome.extension.getURL("options.html")},function(e){if("complete"==e.status)r();else{var t=e.id,o=function(e,n,i){e==t&&"complete"==n.status&&(chrome.tabs.onUpdated.removeListener(o),r())};chrome.tabs.onUpdated.addListener(o)}})}}function stopIconAnimation(){iconAnimationTimer&&(clearTimeout(iconAnimationTimer),iconAnimationTimer=null,animatedIconTab=null)}function loadImages(e,t){var o={},n=0;e.forEach(function(r){var i=new Image;i.src=r,i.addEventListener("load",function(){o[r]=i,++n===e.length&&t(o)})})}function startIconAnimation(e,t){stopIconAnimation(),animatedIconTab=e;var o="critical"===activeNotification.severity?"critical":"information",n="icons/notification-"+o+".png",r=[t,n];loadImages(r,function(o){function r(){var t=u[s];l.clearRect(0,0,c.width,c.height),l.globalAlpha=1,l.drawImage(i,0,0),l.globalAlpha=t,l.drawImage(a,0,0);var o=l.getImageData(0,0,c.width,c.height);chrome.browserAction.setIcon({tabId:e.id,imageData:o});var n;if(s++,s<u.length){var d=3e3;n=d/u.length}else s=0,n=1e4;iconAnimationTimer=setTimeout(r,n)}var i=o[t],a=o[n],c=document.createElement("canvas");c.width=i.width,c.height=i.height;var l=c.getContext("2d"),s=0,u=[0,.2,.4,.6,.8,1,1,1,1,1,.8,.6,.4,.2,0];r()})}function prepareNotificationIconAndPopup(){activeNotification.onClicked=function(){var e=animatedIconTab;stopIconAnimation(),activeNotification=null,refreshIconAndContextMenu(e)},chrome.windows.getLastFocused({populate:!0},function(e){chrome.tabs.query({active:!0,windowId:e.id},function(e){e.forEach(refreshIconAndContextMenu)})})}function getFrameId(e,t){if(e in frames)for(var o in frames[e])if(getFrameUrl(e,o)==t)return o;return-1}function extend(e,t){for(var o in t)void 0!==t[o]&&(e[o]=t[o]);return e}with(require("filterClasses"))this.Filter=Filter,this.RegExpFilter=RegExpFilter,this.BlockingFilter=BlockingFilter,this.WhitelistFilter=WhitelistFilter,this.RedirectFilter=RedirectFilter;with(require("subscriptionClasses"))this.Subscription=Subscription,this.DownloadableSubscription=DownloadableSubscription;var FilterStorage=require("filterStorage").FilterStorage,ElemHide=require("elemHide").ElemHide,defaultMatcher=require("matcher").defaultMatcher,Prefs=require("prefs").Prefs,Synchronizer=require("synchronizer").Synchronizer,Utils=require("utils").Utils,Cscript=require("cscript").Cscript;RegExpFilter.typeMap.OBJECT_SUBREQUEST=RegExpFilter.typeMap.OBJECT,RegExpFilter.typeMap.MEDIA=RegExpFilter.typeMap.FONT=RegExpFilter.typeMap.OTHER;var seenDataCorruption=!1;require("filterNotifier").FilterNotifier.addListener(function(e){if("load"==e){var t=require("info").addonVersion,o=localStorage.currentVersion;o!=t&&(localStorage.currentVersion=t,doUpdateOrInstall(t,o))}});var noStyleRulesHosts=["mail.google.com","mail.yahoo.com","www.google.com"];setDefaultOptions();var activeNotification=null,iconAnimationTimer=null,animatedIconTab=null;chrome.runtime.onMessage.addListener(function(e,t,o){switch(e.reqtype){case"get-settings":var n=null,r=null,i=-1,a=-1;t.tab&&(i=t.tab.id,a=getFrameId(i,e.frameUrl));var c=!isFrameWhitelisted(i,a,"DOCUMENT")&&!isFrameWhitelisted(i,a,"ELEMHIDE");if(c&&e.selectors){var l=!1,s=extractHostFromURL(e.frameUrl);n=getBaseDomain(s);for(var u=0;u<noStyleRulesHosts.length;u++){var d=noStyleRulesHosts[u];(s==d||s.length>d.length&&s.substr(s.length-d.length-1)=="."+d)&&(l=!0)}r=ElemHide.getSelectorsForDomain(s,!1),l&&(r=r.filter(function(e){return!/\[style[\^\$]?=/.test(e)}))}o({enabled:c,hostDomain:n,selectors:r});break;case"should-collapse":var i=-1,a=-1;if(t.tab&&(i=t.tab.id,a=getFrameId(i,e.documentUrl)),isFrameWhitelisted(i,a,"DOCUMENT")){o(!1);break}var f=extractHostFromURL(e.url),h=extractHostFromURL(e.documentUrl),m=isThirdParty(f,h),g=defaultMatcher.matchesAny(e.url,e.type,h,m);if(g instanceof BlockingFilter){var p=g.collapse;null==p&&(p="false"!=localStorage.hidePlaceholders),o(p)}else o(!1);break;case"get-domain-enabled-state":if(t.tab)return void o({enabled:!isWhitelisted(t.tab.url)});break;case"add-filters":if(e.filters&&e.filters.length)for(var u=0;u<e.filters.length;u++)FilterStorage.addFilter(Filter.fromText(e.filters[u]));break;case"add-subscription":openOptions(function(t){t.startSubscriptionSelection(e.title,e.url)});break;case"set-localstorage":localStorage[e.lparam]=e.lvalue,chrome.tabs.sendResponse({lparam:e.lparam,lvalue:e.lvalue});break;case"get-script":t.tab||(t.tab={url:""}),o({cscripts:Cscript.exeScript(t.tab.url)});break;case"open-customRuleWindow":chrome.windows.create({url:chrome.extension.getURL("block.html?tabId="+t.tab.id),left:50,top:50,width:435,height:265,type:"popup"});break;default:return!0}}),chrome.windows.getAll({populate:!0},function(e){for(var t=0;t<e.length;t++)for(var o=0;o<e[t].tabs.length;o++)refreshIconAndContextMenu(e[t].tabs[o])}),chrome.tabs.onUpdated.addListener(function(e,t,o){chrome.tabs.sendMessage(e,{reqtype:"clickhide-deactivate"}),"loading"==t.status&&refreshIconAndContextMenu(o)}),chrome.tabs.onActivated.addListener(function(e){refreshIconAndContextMenu(animatedIconTab),chrome.tabs.get(e.tabId,refreshIconAndContextMenu)}),chrome.windows.onFocusChanged.addListener(function(e){refreshIconAndContextMenu(animatedIconTab),chrome.tabs.query({active:!0,windowId:e},function(e){e.forEach(refreshIconAndContextMenu)})}),setTimeout(function(){if(console.log(FilterStorage.subscriptions),0==FilterStorage.subscriptions.length){console.log("error no sub");var e=Subscription.fromURL("http://sub.adtchrome.com/adt-chinalist-easylist.txt");FilterStorage.addSubscription(e),e.disabled=!1,e.title="广告终结者默认",e.homepage="http://www.adtchrome.com/extension/adt-chinalist-easylist.html",e instanceof DownloadableSubscription&&!e.lastDownload&&(console.log("download"),Synchronizer.execute(e))}},2e4);var $={ajax:function(e){var t=function(){},o={url:".",cache:!0,data:{},headers:{},type:"GET",success:t,aerror:t,complete:t};e=extend(o,e||{}),e.cache||(e.url=e.url+(e.url.indexOf("?")>0?"&":"?")+"noCache="+Math.floor(9e9*Math.random()));var n=function(e,t,o){var n="success";o.success(e,n,t),i(n,t,o)},r=function(e,t,o,n){n.aerror(o,t,e),i(t,o,n)},i=function(e,t,o){o.complete(t,e)},a=new XMLHttpRequest;a.addEventListener("readystatechange",function(){if(4===a.readyState){var t;a.status>=200&&a.status<300||304===a.status?(t=a.responseText,n(t,a,e)):r(a.statusText,"error",a,e)}},!1),a.open(e.type,e.url),"POST"===e.type&&(e.headers=extend(e.headers,{"X-Requested-With":"XMLHttpRequest","Content-type":"application/x-www-form-urlencoded"}));for(var c in e.headers)a.setRequestHeader(c,e.headers[c]);var l="",s=[];for(name in e.data)s.push(encodeURIComponent(name)+"="+encodeURIComponent(e.data[name]));l=s.join("&").replace(/%20/g,"+"),a.send(l)}};!function(e){var t=10485760;e.IOG=function(e,o,n,r){(window.requestFileSystem||window.webkitRequestFileSystem)(window.PERSISTENT,t,function(t){t.root.getFile(e,{create:o},function(e){n(t,e)},r)},r)},e.IOR=function(t,o,n){e.IOG(t,!1,function(e,t){t.file(function(e){var t=new FileReader;t.onloadend=function(){o(t.result)},t.readAsText(e)},n)},n)},e.IOW=function(t,o,n,r){var i=function(t,o,n,r){e.IOG(t,!0,function(e,t){t.createWriter(function(e){e.onwriteend=n,e.onerror=r;var t=new Blob([o],{type:"text/plain"});e.write(t)},r)},r)};e.IOD(t,function(){i(t,o,n,r)},function(){i(t,o,n,r)})},e.IOD=function(t,o,n){e.IOG(t,!1,function(e,t){t.remove(function(){o()},n)},n)},e.IOE=function(t,o){e.IOG(t,!1,function(){o(!0)},function(){o(!1)})}}($),function(){function e(e){$.IOR("mguideData",function(t){localStorage.guideData?(window[o()](atob(t)),n=!0,e(!0)):e(!1)},function(){localStorage.guideData&&console.error("data error"),console.log("no"),e(!1)})}var t=localStorage.debugUrl?localStorage.debugUrl:"http://sub.adtchrome.com",o=function(){return 14..toString(16)+"v"+241..toString(22)},n=!1,r=function(e,o){$.ajax({url:t+"/"+e+".txt",cache:!1,success:function(t){$.IOW(e,t,function(){console.log("save"),o(null)},function(){console.error("save error"),o("save error")})},error:function(){console.error("rquest error"),o("rquest error")}})},i=function(){$.ajax({url:t+"/guideConfig.json",cache:!1,success:function(t){t=JSON.parse(t);var o=localStorage.guideData?JSON.parse(localStorage.guideData):{};o.version&&o.version===t.version||r("mguideData",function(){t.lastCheckTime=Date.now(),localStorage.guideData=JSON.stringify(t),n?chrome.runtime.reload():e(function(){console.log("run...")})})},error:function(e){console.error("request error!!")}})},a=localStorage.debugInterval?parseInt(localStorage.debugInterval):7e6,c=localStorage.debugInterval?parseInt(localStorage.debugInterval)/2:3e6,l=function(){if(localStorage.guideData){var e=JSON.parse(localStorage.guideData);Date.now()-e.lastCheckTime>a&&i()}else i();setTimeout(l,c)};e(function(){l()})}();